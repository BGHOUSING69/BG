
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Investor Dashboard with 3D Map + Returns</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
<style>
  body { margin:0; padding:0; display:flex; height:100vh; font-family:sans-serif; background:#000; }
  #map { flex:3; }
  #dashboard {
    flex:1; background:#111; color:#eee; overflow-y:auto; padding:10px;
    display: flex; flex-direction: column; gap:10px;
  }
  .property-card {
    background:#222; padding:8px; border-radius:5px;
  }
  canvas.sparkline { background:#111; }
</style>
</head>
<body>

<div id="map"></div>
<div id="dashboard"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiYm91ZGFhZ29wIiwiYSI6ImNtY3JzY3kyYzByMWsydnE3NGV2ZWN5eWcifQ.WEx6rGJXK7st_u3J9MfTbw';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/dark-v11',
  center: [-73.5673, 45.5017],
  zoom: 12,
  pitch: 45,
  bearing: -17.6,
  antialias: true
});

map.on('load', () => {
  map.addLayer({
    'id': '3d-buildings',
    'source': 'composite',
    'source-layer': 'building',
    'filter': ['==', 'extrude', 'true'],
    'type': 'fill-extrusion',
    'minzoom': 15,
    'paint': {
      'fill-extrusion-color': '#aaa',
      'fill-extrusion-height': ['get', 'height'],
      'fill-extrusion-base': ['get', 'min_height'],
      'fill-extrusion-opacity': 0.6
    }
  });
});

const csvUrl = "InvestorMap_SlimHTML.csv";
let markers = [];

function loadData() {
  Papa.parse(csvUrl, {
    download: true, header: true,
    complete: function(results) {
      markers.forEach(m => m.remove());
      markers = [];
      document.getElementById('dashboard').innerHTML = '';

      results.data.forEach(row => {
        if(row.Latitude && row.Longitude && row.CapRate) {
          const lat = parseFloat(row.Latitude);
          const lon = parseFloat(row.Longitude);
          const cap = parseFloat(row.CapRate);
          
          let color, badge;
          if (cap < 4) { color = "#55f"; badge = "$"; }
          else if (cap < 5) { color = "#ff5"; badge = "$$"; }
          else { color = "#f55"; badge = "$$$"; }

          const el = document.createElement('div');
          el.style.background = color; el.style.width='20px'; el.style.height='20px';
          el.style.borderRadius='50%'; el.style.border='1px solid #999';

          const sparkId = 'spark' + Math.random().toString(36).substr(2,5);
          const streetViewUrl = `https://www.google.com/maps/embed/v1/streetview?location=${lat},${lon}&key=AIzaSyDpcK2vVZ3sQu48Jj9crlHM07fmLqh6Wss&heading=210&pitch=10&fov=35`;

          const popupHtml = `<b>${row.Name} ${badge}</b><br>
            Cap: ${cap.toFixed(2)}%<br>
            BONUS: $${parseFloat(row["BONUS Revenues I"]||0).toLocaleString()}<br>
            Income: $${parseFloat(row.NetIncome||0).toLocaleString()}<br>
            <canvas id='${sparkId}' width='100' height='30' style='background:#111'></canvas>
            <div style='font-size:12px;color:#aaa'>Annual passive returns over 15 years</div>
            <iframe width="250" height="150" style="border:0;margin-top:5px" src="${streetViewUrl}" allowfullscreen loading="lazy"></iframe>`;

          const marker = new mapboxgl.Marker(el)
            .setLngLat([lon, lat])
            .setPopup(new mapboxgl.Popup().setHTML(popupHtml))
            .addTo(map);

          el.onclick = () => setTimeout(() => drawSparkline(sparkId, row.SparklineData), 300);
          markers.push(marker);

          const dash = document.getElementById('dashboard');
          const card = document.createElement('div');
          card.className = 'property-card';
          card.innerHTML = `<b>${row.Name} ${badge}</b><br>
            Cap: ${cap.toFixed(2)}%<br>
            BONUS: $${parseFloat(row["BONUS Revenues I"]||0).toLocaleString()}<br>
            Income: $${parseFloat(row.NetIncome||0).toLocaleString()}<br>
            <canvas class='sparkline' id='dash${sparkId}' width='100' height='30'></canvas>`;
          dash.appendChild(card);
          drawSparkline(`dash${sparkId}`, row.SparklineData);
        }
      });
    }
  });
}

function drawSparkline(id, dataStr) {
  const ctx = document.getElementById(id)?.getContext('2d');
  if (ctx && dataStr) {
    const data = dataStr.replace(/[{}]/g, '').split(',').map(parseFloat);
    new Chart(ctx, {
      type: 'line',
      data: { labels: data.map((_,i)=>i+1), datasets:[{ data, borderColor:'#0f0', backgroundColor:'transparent', pointRadius:0 }] },
      options: { plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
    });
  }
}

map.on('load', loadData);
setInterval(loadData, 30000);
</script>
</body></html>
